name: Marketplace Validation

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff mypy pyyaml

      - name: Validate marketplace structure
        run: |
          echo "=== Validating Marketplace Structure ==="

          # Check marketplace.json exists and is valid JSON
          if [ -f ".claude-plugin/marketplace.json" ]; then
            echo "OK marketplace.json exists"
            python -c "import json; json.load(open('.claude-plugin/marketplace.json'))" && echo "OK marketplace.json is valid JSON"
          else
            echo "FAIL marketplace.json not found"
            exit 1
          fi

          # Validate all plugin entries have required fields and valid sources
          python3 -c "
          import json, sys
          with open('.claude-plugin/marketplace.json') as f:
              data = json.load(f)
          if not data.get('name'):
              print('FAIL: missing marketplace name')
              sys.exit(1)
          plugins = data.get('plugins', [])
          if not plugins:
              print('FAIL: no plugins defined')
              sys.exit(1)
          for p in plugins:
              name = p.get('name', '?')
              if not p.get('name'):
                  print(f'FAIL: plugin entry missing name')
                  sys.exit(1)
              source = p.get('source')
              if not source:
                  print(f'FAIL: plugin {name} missing source')
                  sys.exit(1)
              if isinstance(source, dict):
                  if source.get('type') != 'git' or not source.get('repository'):
                      print(f'FAIL: plugin {name} URL source missing type or repository')
                      sys.exit(1)
                  print(f'OK {name}: URL source -> {source[\"repository\"]}')
              elif isinstance(source, str):
                  print(f'OK {name}: path source -> {source}')
              else:
                  print(f'FAIL: plugin {name} invalid source type')
                  sys.exit(1)
          print(f'')
          print(f'=== All {len(plugins)} plugin entries validated ===')
          "

      - name: Lint marketplace scripts
        run: |
          echo "=== Linting marketplace scripts ==="
          if [ -d "scripts" ]; then
            ruff check scripts/ --select=E,F,W --ignore=E501 || echo "WARNING Some lint warnings (non-blocking)"
          else
            echo "No scripts/ directory to lint"
          fi
