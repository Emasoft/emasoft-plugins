name: Marketplace Validation

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff mypy pyyaml

      - name: Validate marketplace structure
        run: |
          echo "=== Validating Marketplace Structure ==="

          # Check marketplace.json exists and is valid JSON
          if [ -f ".claude-plugin/marketplace.json" ]; then
            echo "OK marketplace.json exists"
            python -c "import json; json.load(open('.claude-plugin/marketplace.json'))" && echo "OK marketplace.json is valid JSON"
          else
            echo "FAIL marketplace.json not found"
            exit 1
          fi

          # Validate all plugin entries have required fields and valid sources.
          #
          # IMPORTANT: This is inline Python inside a YAML double-quoted shell string.
          # Shell quoting rules apply -- the shell strips inner double quotes before
          # Python sees the code. Therefore:
          #   - NEVER use dict["key"] inside f-strings (shell eats the quotes,
          #     Python sees bare `key` as an undefined variable -> NameError)
          #   - ALWAYS extract dict values into local variables first, then
          #     reference those variables in f-strings
          #   - Use only single quotes inside f-strings
          # See CLAUDE.md "CI/CD Pitfalls" section for full explanation.
          python3 -c "
          import json, sys
          with open('.claude-plugin/marketplace.json') as f:
              data = json.load(f)
          if not data.get('name'):
              print('FAIL: missing marketplace name')
              sys.exit(1)
          plugins = data.get('plugins', [])
          if not plugins:
              print('FAIL: no plugins defined')
              sys.exit(1)
          for p in plugins:
              name = p.get('name', '?')
              if not p.get('name'):
                  print(f'FAIL: plugin entry missing name')
                  sys.exit(1)
              source = p.get('source')
              if not source:
                  print(f'FAIL: plugin {name} missing source')
                  sys.exit(1)
              if isinstance(source, dict):
                  src_type = source.get('source')
                  # Extract values into locals -- do NOT use source['repo'] in
                  # f-strings because shell quoting will mangle the double quotes
                  repo = source.get('repo', '')
                  url = source.get('url', '')
                  if src_type == 'github' and repo:
                      print(f'OK {name}: GitHub source -> {repo}')
                  elif src_type == 'url' and url:
                      print(f'OK {name}: URL source -> {url}')
                  else:
                      print(f'FAIL: plugin {name} invalid source object (needs source+repo or source+url)')
                      sys.exit(1)
              elif isinstance(source, str):
                  print(f'OK {name}: path source -> {source}')
              else:
                  print(f'FAIL: plugin {name} invalid source type')
                  sys.exit(1)
          print(f'')
          print(f'=== All {len(plugins)} plugin entries validated ===')
          "

      - name: Lint marketplace scripts
        run: |
          echo "=== Linting marketplace scripts ==="
          if [ -d "scripts" ]; then
            ruff check scripts/ --select=E,F,W --ignore=E501 || echo "WARNING Some lint warnings (non-blocking)"
          else
            echo "No scripts/ directory to lint"
          fi
